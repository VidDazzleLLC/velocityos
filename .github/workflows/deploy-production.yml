name: Deploy to Production

# This workflow deploys VelocityOS to production Firebase environment
# It is manually triggered to ensure controlled production deployments

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

# Set minimal permissions for security
permissions:
  contents: read

jobs:
  # Confirmation check
  confirm-deployment:
    name: Confirm Production Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "âŒ Deployment cancelled - confirmation required"
            echo "To deploy to production, enter 'DEPLOY' in the confirmation field"
            exit 1
          fi
          echo "âœ… Production deployment confirmed"

  # Build and deploy hosting
  deploy-hosting:
    name: Deploy Hosting to Production
    runs-on: ubuntu-latest
    needs: confirm-deployment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'velocity-os-rebuilt/package-lock.json'

      - name: Install & build hosting (velocity-os-rebuilt)
        working-directory: velocity-os-rebuilt
        run: |
          npm ci
          npm run build

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      - name: Setup Firebase Authentication
        run: |
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "Using Service Account authentication..."
            echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > $HOME/gcloud-key.json
            echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json" >> $GITHUB_ENV
          elif [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
            echo "Using Firebase Token authentication..."
            echo "FIREBASE_TOKEN=${{ secrets.FIREBASE_TOKEN }}" >> $GITHUB_ENV
          else
            echo "ERROR: No Firebase authentication credentials found!"
            echo "Please set either FIREBASE_SERVICE_ACCOUNT_KEY or FIREBASE_TOKEN secret in repository settings."
            exit 1
          fi

      - name: Deploy to Firebase Hosting (Production)
        run: |
          echo "ğŸš€ Deploying to Firebase Hosting (PRODUCTION)..."
          firebase use prod
          firebase deploy --only hosting --non-interactive
          echo "âœ… Production hosting deployment complete!"

  # Build and deploy functions
  deploy-functions:
    name: Deploy Functions to Production
    runs-on: ubuntu-latest
    needs: confirm-deployment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'functions/package-lock.json'

      - name: Install functions dependencies
        working-directory: functions
        run: npm ci

      - name: Build TypeScript functions
        working-directory: functions
        run: npm run build

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      - name: Setup Firebase Authentication
        run: |
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "Using Service Account authentication..."
            echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > $HOME/gcloud-key.json
            echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json" >> $GITHUB_ENV
          elif [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
            echo "Using Firebase Token authentication..."
            echo "FIREBASE_TOKEN=${{ secrets.FIREBASE_TOKEN }}" >> $GITHUB_ENV
          else
            echo "ERROR: No Firebase authentication credentials found!"
            echo "Please set either FIREBASE_SERVICE_ACCOUNT_KEY or FIREBASE_TOKEN secret in repository settings."
            exit 1
          fi

      - name: Deploy Functions (Production)
        run: |
          echo "ğŸš€ Deploying Cloud Functions (PRODUCTION)..."
          firebase use prod
          firebase deploy --only functions --non-interactive
          echo "âœ… Production functions deployment complete!"

  # Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-hosting, deploy-functions]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get project ID
        id: project-id
        run: |
          # Use Python for robust JSON parsing
          PROD_PROJECT=$(python3 -c "import json; f=open('.firebaserc'); data=json.load(f); print(data['projects']['prod'])")
          echo "project_id=$PROD_PROJECT" >> $GITHUB_OUTPUT
      
      - name: Display deployment summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   Production Deployment Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Hosting: ${{ needs.deploy-hosting.result }}"
          echo "Functions: ${{ needs.deploy-functions.result }}"
          echo ""
          
          if [ "${{ needs.deploy-hosting.result }}" == "success" ] && \
             [ "${{ needs.deploy-functions.result }}" == "success" ]; then
            echo "âœ… Production deployment successful!"
            echo ""
            echo "ğŸŒ Your app is live at:"
            echo "   https://${{ steps.project-id.outputs.project_id }}.web.app"
            echo "   https://${{ steps.project-id.outputs.project_id }}.firebaseapp.com"
            echo ""
            echo "ğŸ“Š Firebase Console:"
            echo "   https://console.firebase.google.com/project/${{ steps.project-id.outputs.project_id }}"
            echo ""
            echo "Next steps:"
            echo "  1. Test the production deployment"
            echo "  2. Verify authentication works"
            echo "  3. Check API endpoints"
            echo "  4. Monitor Firebase Console for errors"
            echo ""
          else
            echo "âŒ Production deployment had failures"
            echo ""
            echo "Please check the logs above for details."
            echo ""
            exit 1
          fi
