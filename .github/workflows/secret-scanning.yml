name: Secret Scanning

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional for enterprise features

      - name: Report Findings
        if: failure()
        run: |
          echo "⚠️ Gitleaks detected potential secrets in the codebase!"
          echo "Please review the findings above and remove any exposed secrets."
          echo "See SECURITY_REMEDIATION.md for remediation steps."

  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@v3.91.0
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  custom-patterns:
    name: Custom Pattern Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for Firebase tokens
        run: |
          echo "Scanning for Firebase CI tokens..."
          # Exclude documentation files and lock files - they contain example tokens or hashes
          # Firebase CI tokens follow the pattern: 1//[base64-like-string]
          # Exit code 1 from git grep means no matches found (success for security)
          if git grep -E "1//[0-9A-Za-z_-]{20,}" -- \
            ':(exclude)*.md' \
            ':(exclude)*.lock' \
            ':(exclude)*-lock.json' \
            ':(exclude).git-secrets-patterns' \
            ':(exclude).github/workflows/secret-scanning.yml'; then
            echo "❌ ERROR: Firebase CI token pattern detected in source code!"
            echo "This is likely a real credential and must be removed immediately!"
            exit 1
          else
            echo "✓ No Firebase tokens found in source code"
          fi

      - name: Scan for API keys
        run: |
          echo "Scanning for API keys..."
          # Exclude documentation files - they may contain example API key formats
          # Exit code 1 from git grep means no matches found (success for security)
          if git grep -E "AIza[0-9A-Za-z_-]{35}" -- \
            ':(exclude)*.md'; then
            echo "❌ ERROR: API key pattern detected in source code!"
            echo "This may be a real credential - please verify and remove if real"
            exit 1
          else
            echo "✓ No API keys found in source code"
          fi

      - name: Scan for hardcoded credentials
        run: |
          echo "Scanning for hardcoded credentials..."
          # Exclude test files, examples, and documentation
          # Exit code 1 from git grep means no matches found (success for security)
          # Match both quoted and unquoted credential assignments
          if git grep -iE "(password|secret|api_?key|token)\s*[:=]\s*['\"]?[A-Za-z0-9_-]{8,}['\"]?" -- \
            ':(exclude)*.md' \
            ':(exclude).env.example' \
            ':(exclude).env.test.example' \
            ':(exclude)e2e/**' \
            ':(exclude)**/*.test.ts' \
            ':(exclude)**/*.spec.ts' | \
            grep -v "process.env" | \
            grep -v "placeholder" | \
            grep -v "example" | \
            grep -v "YOUR_"; then
            echo "❌ ERROR: Potential hardcoded credentials detected!"
            echo "Credentials should be in environment variables, not in code"
            exit 1
          else
            echo "✓ No hardcoded credentials found"
          fi

      - name: Check for .env files
        run: |
          echo "Checking for accidentally committed .env files..."
          if git ls-files | grep -E "^\.env(\.[^.]+)?$" | grep -v -E "\.(example|template|test\.example)$"; then
            echo "❌ ERROR: .env file(s) found in git! These should never be committed."
            echo "Please remove them and add to .gitignore"
            exit 1
          else
            echo "✓ No .env files found in repository"
          fi

      - name: Summary
        if: always()
        run: |
          echo "✅ Secret scanning complete"
          echo "Review any warnings above and ensure no real secrets are committed"
          echo "See SECURITY_REMEDIATION.md for best practices"
