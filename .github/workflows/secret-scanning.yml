name: Secret Scanning

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional for enterprise features
        continue-on-error: true

      - name: Report Findings
        if: failure()
        run: |
          echo "⚠️ Gitleaks detected potential secrets in the codebase!"
          echo "Please review the findings above and remove any exposed secrets."
          echo "See SECURITY_REMEDIATION.md for remediation steps."

  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

  custom-patterns:
    name: Custom Pattern Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for Firebase tokens
        run: |
          echo "Scanning for Firebase CI tokens..."
          if git grep -E "1//[0-9A-Za-z_-]{30,}" -- ':!.git-secrets-patterns' ':!.github/workflows/' ':!SECURITY_REMEDIATION.md' ':!*.md' || true; then
            echo "⚠️ Warning: Potential Firebase CI token pattern detected"
            echo "Please verify these are example tokens only, not real credentials"
            exit 0  # Don't fail build for documentation
          fi

      - name: Scan for API keys
        run: |
          echo "Scanning for API keys..."
          if git grep -E "AIza[0-9A-Za-z_-]{35}" -- ':!*.md' || true; then
            echo "⚠️ Warning: Potential API key pattern detected"
            exit 0  # Don't fail build for documentation
          fi

      - name: Scan for hardcoded credentials
        run: |
          echo "Scanning for hardcoded credentials..."
          # Exclude test files, examples, and documentation
          git grep -iE "(password|secret|token|key)\s*=\s*['\"][^'\"]{8,}['\"]" -- \
            ':!*.md' ':!.env.example' ':!.env.test.example' \
            ':!e2e/**' ':!**/*.test.ts' ':!**/*.spec.ts' || echo "✓ No hardcoded credentials found"

      - name: Check for .env files
        run: |
          echo "Checking for accidentally committed .env files..."
          if git ls-files | grep -E "^\.env$|^\.env\.[^.]+$" | grep -v "\.env\.example$" | grep -v "\.env\.test\.example$"; then
            echo "❌ ERROR: .env file(s) found in git! These should never be committed."
            echo "Please remove them and add to .gitignore"
            exit 1
          else
            echo "✓ No .env files found in repository"
          fi

      - name: Summary
        if: always()
        run: |
          echo "✅ Secret scanning complete"
          echo "Review any warnings above and ensure no real secrets are committed"
          echo "See SECURITY_REMEDIATION.md for best practices"
